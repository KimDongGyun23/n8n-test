/**
 * Ollama 응답을 받아 분석 결과를 준비하는 n8n Function 노드
 *
 * - Ollama의 응답이 JSON 형식이라고 가정하고 파싱 시도
 * - 분석 결과에서 브랜치명, 커밋 메시지, PR 제목/본문을 추출
 * - fix_code가 불완전할 경우 원본 코드 유지
 * - GitHub API 요청에 사용할 JSON body 미리 생성
 */
const ollamaResponse = $input.first().json;
const prevData = $("Decode & Prepare Ollama").first().json;

/**
 * Ollama 응답을 JSON으로 파싱 시도
 *
 * - 파싱 실패 시 분석 결과에 실패 원인과 함께 원본 코드 유지
 */
let analysis;
try {
  analysis = JSON.parse(ollamaResponse.response);
} catch (e) {
  analysis = {
    summary: "Ollama 응답 파싱 실패",
    possible_causes: [ollamaResponse.response?.substring(0, 200) || "unknown"],
    fix_strategy: "원본 코드를 유지합니다",
    fix_code: prevData.source_code,
    commit_msg: "fix: auto-fix attempt for " + prevData.message,
    pr_title: "Auto-fix: " + prevData.message,
    pr_body: "Sentry 에러 자동 수정 시도 (Ollama 응답 파싱 실패)",
    test_steps: [],
    risk_level: "LOW",
  };
}

/**
 * 브랜치명, 커밋 메시지, PR 제목/본문을 분석 결과에서 가져옴
 *
 * - 브랜치명은 고유해야 하므로 event_id 앞 8자리 사용
 * - 커밋 메시지, PR 제목/본문은 분석 결과에 없으면 기본값 사용
 */
const branchName = "fix/sentry-" + prevData.event_id.substring(0, 8);
const commitMsg = analysis.commit_msg || "fix: auto-fix from sentry";
const prTitle = analysis.pr_title || "Auto-fix: " + prevData.message;
const prBody = analysis.pr_body || "Sentry 에러 자동 수정";

// fix_code에서 마크다운 코드블록 제거
let fixCode = analysis.fix_code || prevData.source_code;
fixCode = fixCode
  .replace(/^```[a-zA-Z]*\n?/, "")
  .replace(/\n?```$/, "")
  .trim();

/**
 * fix_code가 불완전하면 원본 유지 (안전장치)
 *
 * - 원본 대비 fix_code의 라인 수가 50% 미만이거나
 * - fix_code에 import 구문이 없는데 원본에는 import 구문이 있는 경우
 */
const originalLines = prevData.source_code.split("\n").length;
const fixLines = fixCode.split("\n").length;
const isIncomplete = fixLines < originalLines * 0.5;
const isMissingImport = !fixCode.includes("import") && prevData.source_code.includes("import");

if (isIncomplete || isMissingImport) {
  fixCode = prevData.source_code;
  analysis.summary = (analysis.summary || "") + " (fix_code가 불완전하여 원본 유지)";
}

// HTTP Request 노드용 JSON body 미리 생성
const updateFileBody = JSON.stringify({
  message: commitMsg,
  content: Buffer.from(fixCode).toString("base64"),
  sha: prevData.file_sha,
  branch: branchName,
});

// PR 생성용 JSON body 미리 생성
const causesText = Array.isArray(analysis.possible_causes)
  ? analysis.possible_causes.map((c, i) => `${i + 1}. ${c}`).join("\n")
  : "";

const createPrBody = JSON.stringify({
  title: prTitle,
  body:
    "## n8n / Sentry Auto-Fix\n\n" +
    "**Event ID**: " + prevData.event_id + "\n\n" +
    "**Risk Level**: " + (analysis.risk_level || "unknown") + "\n\n" +
    "---\n\n" +
    "### Summary\n\n" +
    (analysis.summary || "") + "\n\n" +
    "---\n\n" +
    "### Possible Causes\n\n" +
    causesText + "\n\n" +
    "---\n\n" +
    "### Fix Strategy\n\n" +
    (analysis.fix_strategy || "") + "\n\n" +
    "---\n\n" +
    prBody + "\n\n" +
    "---\n\n" +
    "_Generated by n8n + Ollama_",
  head: branchName,
  base: "main",
  draft: true,
});

// 최종적으로 Function 노드에서 다음 노드로 전달할 데이터
const respondBody = JSON.stringify({
  success: true,
  branch: branchName,
  summary: analysis.summary || "",
});

return [
  {
    json: {
      event_id: prevData.event_id,
      filename: prevData.filename,
      file_sha: prevData.file_sha,
      branch: branchName,
      summary: analysis.summary,
      possible_causes: analysis.possible_causes,
      fix_strategy: analysis.fix_strategy,
      fix_code: analysis.fix_code,
      commit_msg: commitMsg,
      pr_title: prTitle,
      pr_body: prBody,
      test_steps: analysis.test_steps,
      risk_level: analysis.risk_level,
      update_file_body: updateFileBody,
      create_pr_body: createPrBody,
      respond_body: respondBody,
    },
  },
];

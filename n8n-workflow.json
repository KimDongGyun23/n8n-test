{
  "name": "Error Auto-Fix Notion Bot",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "error-auto-fix"
      },
      "name": "Error Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        250,
        350
      ]
    },
    {
      "parameters": {
        "jsCode": "/**\r\n * í”„ë¡ íŠ¸ì—”ë“œ logger ì—ëŸ¬ í˜ì´ë¡œë“œ ë¶„ì„ ë° ì •ê·œí™”\r\n *\r\n * - ì—ëŸ¬ ë° í˜¸ì¶œ ì§€ì (CallSite) í†µí•© ë¶„ì„\r\n * - 'src/' ê²½ë¡œë¥¼ í¬í•¨í•œ ì‹¤ì œ ì†ŒìŠ¤ ì½”ë“œ ìœ„ì¹˜ ì¶”ì¶œ (ì¤‘ë³µ ì œê±°)\r\n * - ë©”íƒ€ë°ì´í„°(UA, URL) ì •ë¦¬\r\n */\r\nconst item = $input.first();\r\nconst body = item.json.body || item.json;\r\n\r\nconst { error = {}, callSite = {}, meta = {} } = body;\r\n\r\n// ëª¨ë“  íŠ¸ë ˆì´ìŠ¤ í•©ì¹˜ê¸° (ì—ëŸ¬ ë°œìƒ ì§€ì ì´ ì•ì„œë„ë¡ ìˆœì„œ ìœ ì§€)\r\nconst allTraces = [...(error.traces || []), ...(callSite.traces || [])];\r\n\r\nconst seen = new Set();\r\nconst srcFiles = [];\r\n\r\nfor (const trace of allTraces) {\r\n  if (!trace.file) continue;\r\n\r\n  // 'src/' ê²½ë¡œ í¬í•¨ ì—¬ë¶€ í™•ì¸ í›„ ì¶”ì¶œ\r\n  const match = trace.file.match(/(src\\/.*)$/);\r\n  if (!match) continue;\r\n\r\n  // ì¤‘ë³µ ì œê±°: ë™ì¼í•œ íŒŒì¼ ê²½ë¡œëŠ” í•œ ë²ˆë§Œ ê¸°ë¡\r\n  const filePath = match[1];\r\n  if (seen.has(filePath)) continue;\r\n  seen.add(filePath);\r\n\r\n  srcFiles.push({\r\n    file: filePath,\r\n    fn: trace.function,\r\n    location: `${trace.line}:${trace.column}`,\r\n    full: `${filePath}:${trace.line}:${trace.column}`,\r\n  });\r\n}\r\n\r\n/**\r\n * URLì—ì„œ ê²½ë¡œ ë¶€ë¶„ë§Œ ì¶”ì¶œ (ì¿¼ë¦¬, í•´ì‹œ ì œê±°)\r\n */\r\nconst getUrlPath = (urlStr) => {\r\n  if (!urlStr) return \"unknown\";\r\n  const match = urlStr.match(/https?:\\/\\/[^\\/]+(\\/[^?#]*)/);\r\n  if (match && match[1]) return match[1];\r\n\r\n  return urlStr.startsWith(\"/\") ? urlStr.split(/[?#]/)[0] : \"/\";\r\n};\r\n\r\n/**\r\n * UserAgentì—ì„œ í•µì‹¬ ì •ë³´ë§Œ ì¶”ì¶œ\r\n */\r\nfunction parseUA(ua) {\r\n  if (!ua) return { browser: \"unknown\", os: \"unknown\" };\r\n\r\n  let browser = \"Other\";\r\n  if (ua.includes(\"Chrome\")) browser = \"Chrome\";\r\n  else if (ua.includes(\"Firefox\")) browser = \"Firefox\";\r\n  else if (ua.includes(\"Safari\")) browser = \"Safari\";\r\n\r\n  let os = \"Other\";\r\n  if (ua.includes(\"Mac\")) os = \"macOS\";\r\n  else if (ua.includes(\"Win\")) os = \"Windows\";\r\n  else if (ua.includes(\"Android\")) os = \"Android\";\r\n  else if (ua.includes(\"iPhone\")) os = \"iOS\";\r\n\r\n  return { browser, os };\r\n}\r\n\r\nconst uaInfo = parseUA(meta.userAgent);\r\nconst primaryLocation = srcFiles[0]?.full || \"unknown\";\r\nconst stackSummary = srcFiles\r\n  .map((f) => `${f.file.split(\"/\").pop()}:${f.location.split(\":\")[0]}`)\r\n  .join(\" <- \");\r\n\r\nreturn [\r\n  {\r\n    json: {\r\n      title: `[${error.name || \"Error\"}] ${error.message}`,\r\n      callSiteStack: callSite.stack,\r\n      error: {\r\n        ...error,\r\n        srcFiles,\r\n        primaryLocation,\r\n        stackSummary,\r\n      },\r\n      context: {\r\n        url: meta.url,\r\n        path: getUrlPath(meta.url),\r\n        browser: uaInfo.browser,\r\n        os: uaInfo.os,\r\n        userAgent: meta.userAgent,\r\n        env: meta.environment,\r\n      },\r\n      timestamp: meta.timestamp || new Date().toISOString(),\r\n    },\r\n  },\r\n];"
      },
      "name": "Extract Error Info",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        500,
        350
      ]
    },
    {
      "parameters": {
        "jsCode": "/**\n * srcFiles ë°°ì—´ì„ ìˆœíšŒí•˜ë©° ê° íŒŒì¼ì˜ ì ˆëŒ€ ê²½ë¡œë¥¼ ê³„ì‚°í•˜ê³ , ì¡´ì¬ ì—¬ë¶€ë¥¼ í™•ì¸í•œ í›„,\n * ì—ëŸ¬ê°€ ë°œìƒí•œ ìœ„ì¹˜ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì•ë’¤ 20ì¤„ì”©ì˜ ì½”ë“œ ìŠ¤ë‹ˆí«ì„ ìƒì„±í•˜ì—¬ ë°˜í™˜\n *\n * - AIê°€ ì´í•´í•˜ê¸° ì‰½ë„ë¡ ì¤„ ë²ˆí˜¸ì™€ í•¨ê»˜ í‘œì‹œ\n */\nconst fs = require(\"fs\");\nconst path = require(\"path\");\n\nconst data = $input.first().json;\n\n// srcFilesëŠ” extract-error.jsì—ì„œ ì¶”ì¶œëœ ì—ëŸ¬ ë°œìƒ ìœ„ì¹˜ ì •ë³´ ë°°ì—´ (ìµœëŒ€ 3ê°œ)\nconst srcFiles = (data.error?.srcFiles ?? []).slice(0, 3);\n\n/**\n * ê° srcFileì— ëŒ€í•´ ì ˆëŒ€ ê²½ë¡œ ê³„ì‚°, ì¡´ì¬ ì—¬ë¶€ í™•ì¸, ì½”ë“œ ìŠ¤ë‹ˆí« ìƒì„±\n *\n * - ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íŒŒì¼ì€ exists: falseë¡œ í‘œì‹œ\n * - ì½”ë“œ ìŠ¤ë‹ˆí«ì€ ì—ëŸ¬ ë°œìƒ ìœ„ì¹˜ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì•ë’¤ 20ì¤„ì”© í¬í•¨ (ì´ 40ì¤„)\n */\nconst files = srcFiles.map((file) => {\n  const relativePath = file.file;\n  const absolutePath = path.resolve(\"/app\", relativePath);\n\n  let exists = false;\n  let codeSnippet = \"\";\n  let sourceCode = \"\";\n\n  try {\n    if (fs.existsSync(absolutePath)) {\n      exists = true;\n      sourceCode = fs.readFileSync(absolutePath, \"utf-8\");\n\n      if (file.location) {\n        // \"22:15\" -> 22 ì¶”ì¶œ\n        const targetLine = parseInt(file.location.split(\":\")[0]);\n        const lines = sourceCode.split(\"\\n\");\n\n        // ì•ë’¤ 20ì¤„ ë²”ìœ„ ì„¤ì • (íŒŒì¼ ì‹œì‘ê³¼ ë ë²”ìœ„ ì²´í¬)\n        const start = Math.max(0, targetLine - 21);\n        const end = Math.min(lines.length, targetLine + 20);\n\n        // ì¤„ ë²ˆí˜¸ë¥¼ ì¶”ê°€í•˜ì—¬ ìŠ¬ë¼ì´ì‹±\n        codeSnippet = lines\n          .slice(start, end)\n          .map((line, index) => {\n            const currLineNum = start + index + 1;\n            const marker = currLineNum === targetLine ? \" > \" : \"   \";\n            return `${marker}${currLineNum} | ${line}`;\n          })\n          .join(\"\\n\");\n      }\n    }\n  } catch (err) {\n    codeSnippet = `// íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${err.message}`;\n  }\n\n  return {\n    ...file,\n    absolutePath,\n    exists,\n    codeSnippet,\n  };\n});\n\nreturn [\n  {\n    json: {\n      ...data,\n      files,\n      primarySnippet: files[0]?.codeSnippet || \"ì½”ë“œ ìŠ¤ë‹ˆí«ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\",\n      primaryFile: files[0]?.file || \"unknown\",\n    },\n  },\n];"
      },
      "name": "Read Source Files",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        750,
        350
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\r\nconst files = data.files ?? [];\r\nconst primaryFile = files[0];\r\n\r\nconst AI_TEMPRATURE = 0.1;\r\nconst AI_TOP_P = 0.9;\r\nconst AI_NUM_CTX = 8192; // ëª¨ë¸ ì»¨í…ìŠ¤íŠ¸ ê¸¸ì´ í™•ì¥\r\n\r\n// ì›ì¸ ì²´ì¸ ì •ë³´ ê°€ê³µ\r\nconst causesSection =\r\n  (data.error?.causes ?? []).length > 0\r\n    ? data.error.causes.map((c, i) => `${i + 1}. **${c.name}**: ${c.message}`).join(\"\\n\")\r\n    : \"ì—†ìŒ\";\r\n\r\n// AI ë¶„ì„ì„ ìœ„í•œ ì½”ë“œ ì„¹ì…˜ êµ¬ì„±\r\nconst codeContextSection = files\r\n  .map((f) => {\r\n    return `### File: ${f.file}\\n\\`\\`\\`javascript\\n${f.codeSnippet}\\n\\`\\`\\``;\r\n  })\r\n  .join(\"\\n\\n\");\r\n\r\nconst prompt = `ë‹¹ì‹ ì€ ì‹œë‹ˆì–´ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œìì´ì ë””ë²„ê¹… ì „ë¬¸ê°€ì…ë‹ˆë‹¤. \r\nì œê³µëœ ì—ëŸ¬ ë§¥ë½ê³¼ ì†ŒìŠ¤ ì½”ë“œë¥¼ êµì°¨ ë¶„ì„í•˜ì—¬ ê·¼ë³¸ ì›ì¸ì„ ì°¾ê³ , ë…¸ì…˜(Notion) ë¦¬í¬íŠ¸ìš© JSON ì‘ë‹µì„ ìƒì„±í•˜ì„¸ìš”.\r\n\r\n## 1. ì—ëŸ¬ ë§¥ë½\r\n- ì—ëŸ¬ëª…: ${data.title}\r\n- ë©”ì‹œì§€: ${data.error.message}\r\n- ë°œìƒ ìœ„ì¹˜: ${data.error.primaryLocation}\r\n- í˜¸ì¶œ íë¦„: ${data.error.stackSummary}\r\n- í™˜ê²½: ${data.context.os} / ${data.context.browser} (${data.context.env})\r\n\r\n## 2. ì›ì¸ ì²´ì¸ (error.cause)\r\n${causesSection}\r\n\r\n## 3. ê´€ë ¨ ì†ŒìŠ¤ ì½”ë“œ (ì—ëŸ¬ ì§€ì  ì£¼ë³€ë¶€)\r\n${codeContextSection}\r\n\r\n## 4. ìƒì„¸ ë¶„ì„ ë° ì‘ë‹µ ìš”êµ¬ì‚¬í•­ (ì¤‘ìš”)\r\n- **problemAnalysis**: ë‹¨ìˆœ í˜„ìƒì´ ì•„ë‹Œ 'ì™œ' ë°œìƒí–ˆëŠ”ì§€ ë¶„ì„í•˜ì„¸ìš”. í•µì‹¬ í‚¤ì›Œë“œì— **ë³¼ë“œ**ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.\r\n- **fixStrategy**: ì–´ë–¤ ë°©í–¥ìœ¼ë¡œ ê³ ì¹ ì§€ 1~2ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ì„¸ìš”.\r\n- **fixContent**: êµ¬ì²´ì ì¸ ë³€ê²½ ì‚¬í•­ì„ **ë°˜ë“œì‹œ í•œ ì¤„ì— í•˜ë‚˜ì”© ê¸€ë¨¸ë¦¬ ê¸°í˜¸('-')ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ** ì‘ì„±í•˜ì„¸ìš”. ê° ì¤„ ì‚¬ì´ì—ëŠ” ì¤„ë°”ê¿ˆì„ í¬í•¨í•˜ì„¸ìš”.\r\n- **fixCode**: ìˆ˜ì •ì´ í•„ìš”í•œ ë¶€ë¶„ë§Œ **ì‘ì—… ë‹¨ìœ„(í•¨ìˆ˜ ë˜ëŠ” ë¸”ë¡)**ë³„ë¡œ ì‘ì„±í•˜ì„¸ìš”. ì „ì²´ íŒŒì¼ì„ ì‘ì„±í•˜ì§€ ë§ˆì„¸ìš”. ë°˜ë“œì‹œ ë³€ê²½ ì „/í›„ì˜ ë§¥ë½ì„ ì•Œ ìˆ˜ ìˆëŠ” ì£¼ì„ì„ í¬í•¨í•˜ì„¸ìš”. ì¤„ ë²ˆí˜¸ëŠ” ë°˜ë“œì‹œ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.\r\n- **riskLevel**: LOW, MEDIUM, HIGH ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.\r\n- **testSteps**: ê²€ì¦ì„ ìœ„í•´ í•„ìš”í•œ ë‹¨ê³„ë¥¼ ë°°ì—´ í˜•íƒœë¡œ ì‘ì„±í•˜ì„¸ìš”.\r\n\r\n## 5. ì‘ë‹µ í˜•ì‹ (JSONë§Œ ì¶œë ¥, ì½”ë“œ ë¸”ë¡ ê¸°í˜¸ \\`\\`\\`json ê¸ˆì§€)\r\n{\r\n  \"summary\": \"í•œ ì¤„ ìš”ì•½\",\r\n  \"problemAnalysis\": \"ê·¼ë³¸ ì›ì¸ ìƒì„¸ ë¶„ì„\",\r\n  \"fixStrategy\": \"í•´ê²°ì„ ìœ„í•œ ì ‘ê·¼ ë°©ì‹\",\r\n  \"fixContent\": \"- ë³€ê²½ ì‚¬í•­ 1\\\\n- ë³€ê²½ ì‚¬í•­ 2\\\\n- ë³€ê²½ ì‚¬í•­ 3\",\r\n  \"fixFilePath\": \"${primaryFile?.file || \"src/...\"}\",\r\n  \"fixCode\": \"// [ìˆ˜ì •ëœ í•¨ìˆ˜/ë¸”ë¡ëª…]\\\\nfunction example() {\\\\n  // ... ê¸°ì¡´ ì½”ë“œ\\\\n  // FIXED: ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ null ì²´í¬ ì¶”ê°€\\\\n  if (data) { \\\\n    // ... ìˆ˜ì •ëœ ë¡œì§\\\\n  }\\\\n}\",\r\n  \"testSteps\": [\"í…ŒìŠ¤íŠ¸ ë‹¨ê³„ 1\", \"ë‹¨ê³„ 2\"],\r\n  \"riskLevel\": \"LOW | MEDIUM | HIGH\",\r\n}`;\r\n\r\nconst ollamaBody = {\r\n  model: \"deepseek-coder-v2:16b\",\r\n  prompt,\r\n  stream: false,\r\n  format: \"json\",\r\n  options: {\r\n    temperature: AI_TEMPRATURE,\r\n    top_p: AI_TOP_P,\r\n    num_ctx: AI_NUM_CTX,\r\n  },\r\n};\r\n\r\nreturn [\r\n  {\r\n    json: {\r\n      ...data,\r\n      ollamaBody,\r\n    },\r\n  },\r\n];"
      },
      "name": "Build Ollama Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1000,
        350
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:11434/api/generate",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.ollamaBody) }}",
        "options": {
          "timeout": 300000
        }
      },
      "name": "Call Ollama API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1250,
        350
      ]
    },
    {
      "parameters": {
        "jsCode": "/**\r\n * Ollama API ì‘ë‹µì„ íŒŒì‹±í•˜ì—¬ ë¶„ì„ ê²°ê³¼ë¥¼ êµ¬ì¡°í™”í•˜ëŠ” ë…¸ë“œ\r\n */\r\nconst ollamaRaw = $input.first().json;\r\n\r\n// ëª…ì‹œì ìœ¼ë¡œ ì´ì „ ë…¸ë“œ ì´ë¦„ì„ ì§€ì •í•˜ì—¬ ë°ì´í„° ìœ ì‹¤ ë°©ì§€\r\nconst promptData = $(\"Build Ollama Prompt\").first().json;\r\nconst REQUIRED_FIELDS = [\"summary\", \"fixCode\", \"riskLevel\"];\r\n\r\nlet analysis;\r\n\r\ntry {\r\n  // Ollama ë…¸ë“œ ë²„ì „ì— ë”°ë¼ 'response' ë˜ëŠ” 'message.content'ì— ë‹´ê¸¸ ìˆ˜ ìˆìŒ\r\n  const raw = ollamaRaw.response || (ollamaRaw.message && ollamaRaw.message.content) || ollamaRaw;\r\n\r\n  // JSON íŒŒì‹±\r\n  let parsed;\r\n  if (typeof raw === \"string\") parsed = JSON.parse(raw.trim());\r\n  else parsed = raw;\r\n\r\n  // í•„ìˆ˜ í•„ë“œ ê²€ì¦\r\n  const missing = REQUIRED_FIELDS.filter((field) => !parsed[field]);\r\n  if (missing.length > 0) throw new Error(`í•„ìˆ˜ í•„ë“œ ëˆ„ë½: ${missing.join(\", \")}`);\r\n\r\n  // ë°ì´í„° ì •ê·œí™”\r\n  analysis = {\r\n    summary: parsed.summary,\r\n    problemAnalysis: parsed.problemAnalysis ?? \"\",\r\n    fixStrategy: parsed.fixStrategy ?? \"\",\r\n    fixContent: parsed.fixContent ?? \"\",\r\n    fixCode: parsed.fixCode,\r\n    fixFilePath:\r\n      parsed.fixFilePath ?? promptData.error?.primaryLocation?.split(\":\")[0] ?? \"unknown\",\r\n    testSteps: Array.isArray(parsed.testSteps) ? parsed.testSteps : [],\r\n    riskLevel: parsed.riskLevel,\r\n  };\r\n} catch (err) {\r\n  // ì‹¤íŒ¨ ì‹œ í´ë°± ë°ì´í„°\r\n  analysis = {\r\n    summary: \"Ollama ë¶„ì„ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨\",\r\n    problemAnalysis: `ì—ëŸ¬ ìš”ì¸: ${err.message}\\n\\nAI ì›ë³¸ ì‘ë‹µì„ í™•ì¸í•˜ì„¸ìš”.`,\r\n    fixStrategy: \"N/A\",\r\n    fixContent: \"N/A\",\r\n    fixCode: \"// AI ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨ë¡œ ì½”ë“œë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\",\r\n    fixFilePath: \"unknown\",\r\n    testSteps: [],\r\n    riskLevel: \"HIGH\",\r\n    _parseError: true,\r\n    _rawResponse: String(ollamaRaw.response || JSON.stringify(ollamaRaw)).slice(0, 1000),\r\n  };\r\n}\r\n\r\nreturn [\r\n  {\r\n    json: {\r\n      ...promptData,\r\n      ...analysis,\r\n    },\r\n  },\r\n];"
      },
      "name": "Analyze with Ollama",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1500,
        350
      ]
    },
    {
      "parameters": {
        "jsCode": "/**\n * Ollama ë¶„ì„ ê²°ê³¼ë¥¼ Notion ì´ìŠˆ í˜ì´ì§€ ìƒì„± í˜•íƒœë¡œ ê°€ê³µ\n *\n * - Notion API 2000ì ì œí•œ ëŒ€ì‘ (ë¬¸ìì—´ ìŠ¬ë¼ì´ì‹± ë° ë¶„í•  ì²˜ë¦¬ ì¤€ë¹„)\n * - ì—ëŸ¬ ë¦¬í¬íŠ¸ ê°€ë…ì„±ì„ ìœ„í•œ Callout ë¸”ë¡ ë„ì…\n * - ë°ì´í„°ë² ì´ìŠ¤ ì†ì„±ëª… ì •ê·œí™”\n */\nconst data = $input.first().json;\n\n// AI ì‘ë‹µ ì½”ë“œ ì •ì œ (```javascript ... ``` ê¸°í˜¸ ì œê±°)\nconst cleanFixCode = data.fixCode\n  ? data.fixCode.replace(/```[a-z]*\\n?|```/gi, \"\").trim()\n  : \"ìˆ˜ì • ì½”ë“œê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\";\n\n// ê´€ë ¨ íŒŒì¼ ëª©ë¡ ì •ë¦¬\nconst relatedFiles = (data.error?.srcFiles ?? [])\n  .map((f) => `${f.file} (${f.fn ?? \"unknown\"})`)\n  .join(\", \");\n\n// Notion Rich Text í—¬í¼: **bold** íŒ¨í„´ì„ ì¸ì‹í•˜ì—¬ annotations ì ìš©\nfunction parseMarkdown(content) {\n  if (!content) return [];\n\n  // ë³¼ë“œ íŒ¨í„´(**text**)ì„ ê¸°ì¤€ìœ¼ë¡œ í…ìŠ¤íŠ¸ ë¶„í• \n  const parts = content.split(/(\\*\\*.*?\\*\\*)/g);\n\n  return parts\n    .map((part) => {\n      if (part.startsWith(\"**\") && part.endsWith(\"**\")) {\n        // ë³¼ë“œ ì²˜ë¦¬\n        return {\n          text: { content: part.slice(2, -2) },\n          annotations: { bold: true },\n        };\n      }\n      // ì¼ë°˜ í…ìŠ¤íŠ¸\n      return { text: { content: part } };\n    })\n    .filter((p) => p.text.content.length > 0);\n}\n\n/**\n * ì¤„ë°”ê¿ˆê³¼ ê¸€ë¨¸ë¦¬ ê¸°í˜¸ë¥¼ ì¸ì‹í•˜ì—¬ Notion ë¸”ë¡ìœ¼ë¡œ ë³€í™˜\n */\nfunction processSmartBlocks(content) {\n  if (!content) return [blocks.markdownText(\"N/A\")];\n\n  // ì¤„ë°”ê¿ˆìœ¼ë¡œ ë‚˜ëˆ„ê³  ë¹ˆ ì¤„ ì œê±°\n  const lines = content.split(\"\\n\").filter((l) => l.trim().length > 0);\n\n  return lines.map((line) => {\n    const trimmed = line.trim();\n    // '-', 'â€¢', '*' ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° ë¶ˆë › ë¸”ë¡ìœ¼ë¡œ ìƒì„±\n    if (/^[-â€¢*]\\s+/.test(trimmed)) {\n      const cleanText = trimmed.replace(/^[-â€¢*]\\s+/, \"\");\n      return blocks.bullet(cleanText);\n    }\n    // ì¼ë°˜ í…ìŠ¤íŠ¸ì¸ ê²½ìš° ë‹¨ë½ ë¸”ë¡ ìƒì„±\n    return blocks.markdownText(trimmed);\n  });\n}\n\n// Notion ë¸”ë¡ ìƒì„± ìœ í‹¸ë¦¬í‹°\nconst blocks = {\n  heading: (text, level = 2) => ({\n    object: \"block\",\n    type: `heading_${level}`,\n    [`heading_${level}`]: { rich_text: [{ text: { content: text } }] },\n  }),\n  markdownText: (content) => ({\n    object: \"block\",\n    type: \"paragraph\",\n    paragraph: { rich_text: parseMarkdown(content).slice(0, 50) },\n  }),\n  todo: (content) => ({\n    object: \"block\",\n    type: \"to_do\",\n    to_do: {\n      rich_text: parseMarkdown(content),\n      checked: false,\n    },\n  }),\n  callout: (content, icon = \"ğŸ’¡\") => ({\n    object: \"block\",\n    type: \"callout\",\n    callout: {\n      rich_text: parseMarkdown(content),\n      icon: { emoji: icon },\n      color: \"blue_background\",\n    },\n  }),\n  code: (content, language = \"javascript\") => ({\n    object: \"block\",\n    type: \"code\",\n    code: {\n      rich_text: [{ text: { content: content.slice(0, 2000) } }],\n      language: language,\n    },\n  }),\n  bullet: (content) => ({\n    object: \"block\",\n    type: \"bulleted_list_item\",\n    bulleted_list_item: { rich_text: parseMarkdown(content) },\n  }),\n  divider: () => ({ object: \"block\", type: \"divider\", divider: {} }),\n  emptyBlock: () => ({ object: \"block\", type: \"paragraph\", paragraph: { rich_text: [] } }),\n};\n\n// Notion í˜ì´ì§€ ì œëª© ë° ì†ì„± ì„¤ì •\nconst riskEmoji = data.riskLevel === \"HIGH\" ? \"ğŸ”´\" : data.riskLevel === \"MEDIUM\" ? \"ğŸŸ \" : \"ğŸŸ¡\";\nconst pageTitle = `${data.riskLevel}: ${data.error?.message || data.title}`.slice(0, 100);\n\n// í…ŒìŠ¤íŠ¸ ë‹¨ê³„ë¥¼ ê°œë³„ to_do ë¸”ë¡ ë°°ì—´ë¡œ ë³€í™˜\nconst testStepBlocks =\n  Array.isArray(data.testSteps) && data.testSteps.length > 0\n    ? data.testSteps.map((step) => blocks.todo(step))\n    : [blocks.todo(\"ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ ìˆ˜í–‰\")];\n\n// ë…¸ì…˜ í˜ì´ì§€ ìƒì„±ìš© JSON êµ¬ì¡°\nconst notionBody = {\n  parent: { database_id: \"30bc8de20bcb80aeb2f5f99848653d4a\" },\n  icon: { emoji: riskEmoji },\n  properties: {\n    Name: {\n      title: [{ text: { content: pageTitle } }],\n    },\n    Status: {\n      select: { name: \"Open\" },\n    },\n    \"Risk Level\": {\n      select: { name: data.riskLevel || \"MEDIUM\" },\n    },\n    Environment: {\n      select: { name: data.context?.env || \"unknown\" },\n    },\n    \"File Path\": {\n      rich_text: [{ text: { content: data.fixFilePath || \"unknown\" } }],\n    },\n    \"URL Path\": {\n      select: { name: data.context?.path || \"/\" },\n    },\n    \"Error Type\": {\n      select: { name: data.error?.name || \"Error\" },\n    },\n    Timestamp: {\n      date: { start: data.timestamp || new Date().toISOString() },\n    },\n  },\n  children: [\n    blocks.heading(\"ğŸ’¡ AI ì›ì¸ ë¶„ì„\", 2),\n    blocks.divider(),\n    blocks.callout(data.problemAnalysis || \"ë¶„ì„ ë‚´ìš© ì—†ìŒ\", \"ğŸ”\"),\n\n    blocks.emptyBlock(),\n\n    blocks.heading(\"ğŸ› ï¸ ìˆ˜ì • ì „ëµ ë° ë‚´ìš©\", 2),\n    blocks.divider(),\n    blocks.markdownText(`**ìˆ˜ì • ì „ëµ:**`),\n    blocks.markdownText(`${data.fixStrategy || \"N/A\"}`),\n\n    blocks.emptyBlock(),\n\n    blocks.markdownText(`**ìƒì„¸ ë³€ê²½ ë‚´ìš©:**`),\n    ...processSmartBlocks(data.fixContent),\n\n    blocks.emptyBlock(),\n\n    blocks.heading(`ğŸ“ ìˆ˜ì • ì½”ë“œ (${data.fixFilePath})`, 2),\n    blocks.divider(),\n    blocks.code(cleanFixCode, \"javascript\"),\n\n    blocks.emptyBlock(),\n\n    blocks.heading(\"ğŸš¨ ì—ëŸ¬ ìƒì„¸ ë¡œê·¸\", 2),\n    blocks.divider(),\n    blocks.markdownText(`**ì—ëŸ¬ëª…:** ${data.error?.name || \"Error\"}`),\n    blocks.markdownText(`**ë°œìƒ ìœ„ì¹˜:** ${data.error?.primaryLocation}`),\n    blocks.markdownText(`**í˜¸ì¶œ ê²½ë¡œ:** ${data.error?.stackSummary}`),\n    blocks.markdownText(`**ê´€ë ¨ íŒŒì¼:** ${relatedFiles}`),\n\n    blocks.emptyBlock(),\n\n    blocks.heading(\"ğŸ” ì›ë³¸ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤\", 3),\n    blocks.code(data.error?.stack || \"ì›ë³¸ ìŠ¤íƒ ì •ë³´ ì—†ìŒ\", \"plain text\"),\n\n    blocks.emptyBlock(),\n\n    blocks.heading(\"ğŸ”— ì½œì‚¬ì´íŠ¸ ìŠ¤íƒ (ì‹ ê³  ì§€ì )\", 3),\n    blocks.code(data.callSiteStack || \"ì½œì‚¬ì´íŠ¸ ì •ë³´ ì—†ìŒ\", \"plain text\"),\n\n    blocks.emptyBlock(),\n\n    blocks.heading(\"âœ… í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸\", 2),\n    blocks.divider(),\n    ...testStepBlocks,\n  ],\n};\n\nreturn [{ json: { notionBody } }];"
      },
      "name": "Build Notion Page",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1750,
        350
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.notion.com/v1/pages",
        "authentication": "predefinedCredentialType",
        "genericAuthType": "notionApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Notion-Version",
              "value": "2022-06-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.notionBody) }}",
        "options": {}
      },
      "name": "Create Notion Issue",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2000,
        350
      ]
    }
  ],
  "connections": {
    "Error Webhook": {
      "main": [
        [
          {
            "node": "Extract Error Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Error Info": {
      "main": [
        [
          {
            "node": "Read Source Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Source Files": {
      "main": [
        [
          {
            "node": "Build Ollama Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Ollama Prompt": {
      "main": [
        [
          {
            "node": "Call Ollama API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Ollama API": {
      "main": [
        [
          {
            "node": "Analyze with Ollama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze with Ollama": {
      "main": [
        [
          {
            "node": "Build Notion Page",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Notion Page": {
      "main": [
        [
          {
            "node": "Create Notion Issue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}
